<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>

  <head>
    <script type="text/javascript">
    !function(T,l,y){var S=T.location,u="script",k="instrumentationKey",D="ingestionendpoint",C="disableExceptionTracking",E="ai.device.",I="toLowerCase",b="crossOrigin",w="POST",e="appInsightsSDK",t=y.name||"appInsights";(y.name||T[e])&&(T[e]=t);var n=T[t]||function(d){var g=!1,f=!1,m={initialize:!0,queue:[],sv:"4",version:2,config:d};function v(e,t){var n={},a="Browser";return n[E+"id"]=a[I](),n[E+"type"]=a,n["ai.operation.name"]=S&&S.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(m.sv||m.version),{time:function(){var e=new Date;function t(e){var t=""+e;return 1===t.length&&(t="0"+t),t}return e.getUTCFullYear()+"-"+t(1+e.getUTCMonth())+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+((e.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),iKey:e,name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}}}}var h=d.url||y.src;if(h){function a(e){var t,n,a,i,r,o,s,c,p,l,u;g=!0,m.queue=[],f||(f=!0,t=h,s=function(){var e={},t=d.connectionString;if(t)for(var n=t.split(";"),a=0;a<n.length;a++){var i=n[a].split("=");2===i.length&&(e[i[0][I]()]=i[1])}if(!e[D]){var r=e.endpointsuffix,o=r?e.location:null;e[D]="https://"+(o?o+".":"")+"dc."+(r||"services.visualstudio.com")}return e}(),c=s[k]||d[k]||"",p=s[D],l=p?p+"/v2/track":config.endpointUrl,(u=[]).push((n="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",a=t,i=l,(o=(r=v(c,"Exception")).data).baseType="ExceptionData",o.baseData.exceptions=[{typeName:"SDKLoadFailed",message:n.replace(/\./g,"-"),hasFullStack:!1,stack:n+"\nSnippet failed to load ["+a+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(S&&S.pathname||"_unknown_")+"\nEndpoint: "+i,parsedStack:[]}],r)),u.push(function(e,t,n,a){var i=v(c,"Message"),r=i.data;r.baseType="MessageData";var o=r.baseData;return o.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+n+")").replace(/\"/g,"")+'"',o.properties={endpoint:a},i}(0,0,t,l)),function(e,t){if(JSON){var n=T.fetch;if(n&&!y.useXhr)n(t,{method:w,body:JSON.stringify(e),mode:"cors"});else if(XMLHttpRequest){var a=new XMLHttpRequest;a.open(w,t),a.setRequestHeader("Content-type","application/json"),a.send(JSON.stringify(e))}}}(u,l))}function i(e,t){f||setTimeout(function(){!t&&m.core||a()},500)}var e=function(){var n=l.createElement(u);n.src=h;var e=y[b];return!e&&""!==e||"undefined"==n[b]||(n[b]=e),n.onload=i,n.onerror=a,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||i(0,t)},n}();y.ld<0?l.getElementsByTagName("head")[0].appendChild(e):setTimeout(function(){l.getElementsByTagName(u)[0].parentNode.appendChild(e)},y.ld||0)}try{m.cookie=l.cookie}catch(p){}function t(e){for(;e.length;)!function(t){m[t]=function(){var e=arguments;g||m.queue.push(function(){m[t].apply(m,e)})}}(e.pop())}var n="track",r="TrackPage",o="TrackEvent";t([n+"Event",n+"PageView",n+"Exception",n+"Trace",n+"DependencyData",n+"Metric",n+"PageViewPerformance","start"+r,"stop"+r,"start"+o,"stop"+o,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),m.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4};var s=(d.extensionConfig||{}).ApplicationInsightsAnalytics||{};if(!0!==d[C]&&!0!==s[C]){method="onerror",t(["_"+method]);var c=T[method];T[method]=function(e,t,n,a,i){var r=c&&c(e,t,n,a,i);return!0!==r&&m["_"+method]({message:e,url:t,lineNumber:n,columnNumber:a,error:i}),r},d.autoExceptionInstrumented=!0}return m}(y.cfg);(T[t]=n).queue&&0===n.queue.length&&n.trackPageView({})}(window,document,{
    src: "https://az416426.vo.msecnd.net/scripts/b/ai.2.min.js",
    cfg: {
        instrumentationKey: "b0b411e6-3e51-4578-b762-608bb183d4a6"
    }});
    var telemetryInitializer = (envelope) => {
      envelope.data.someField = 'This item passed through my telemetry initializer';
    };
    appInsights.addTelemetryInitializer(telemetryInitializer);
    appInsights.trackTrace({message: 'This message will use a telemetry initializer'});
    var id = null;
    fetch('/.auth/me').then(function(response){
      return response.json();
    }).then(function(data){
      id = data[0].user_id;
      appInsights.setAuthenticatedUserContext(id);
    });
    </script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Module 1: Configure SLO checks in CD Workflow | DevOps Dojo </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Module 1: Configure SLO checks in CD Workflow | DevOps Dojo ">
    <meta name="generator" content="docfx ">
  
    <link rel="shortcut icon" href="../../../../../../favicon.ico">
    <link rel="stylesheet" href="../../../../../../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../../../../../../styles/docfx.css">
    <link rel="stylesheet" href="../../../../../../styles/main.css">
    <meta property="docfx:navrel" content="../../../../../../toc.html">
    <meta property="docfx:tocrel" content="../../../../../toc.html">
  
  
  
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="../../../../../../index.html">
                <div class="msft-logo"></div>
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>

        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div role="main" class="container body-content hide-when-search">

        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">

<p><strong><a href="index.html">Home</a> | <a href="module1.html">Module 1</a> | <a href="module2.html">Module 2</a> |</strong></p>
<h1 id="module-1-configure-slo-checks-in-cd-workflow"><strong>Module 1: Configure SLO checks in CD Workflow</strong></h1>
<hr>
<p><a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/app-insights-overview">Application Insights</a> is an extensible Application Performance Management (APM) service in Azure Monitor to monitor live applications. It will automatically detect performance anomalies, and the powerful analytics tools will help you diagnose issues and to understand what users actually do with your app. It's designed to help you continuously improve performance and usability. It works for apps on a wide variety of platforms including .NET, Node.js, Java, and Python hosted on-premises, hybrid, or any public cloud. It integrates with your DevOps process, and has connection points to a variety of development tools.</p>
<p><a href="https://docs.microsoft.com/en-us/azure/azure-monitor/logs/log-analytics-overview">Log Analytics</a> is a tool in the Azure Monitor to edit and run log queries. You may write a simple query that returns a set of records, and then use sorting and filtering features to analyze them. You can write a more advanced query to perform statistical analysis and visualize the results in a chart to identify a particular trend. Whether you work with the results of your queries interactively or use them with other Azure Monitor features such as log query alerts or workbooks. Log Analytics is the tool that you're going to use write and test them.</p>
<p>To demonstrate error budgeting use case, we have to enable components to fetch and check predefined SLO metrics like <code>latency</code> and <code>availability</code> from Application Insights and Log Analytics in the GitHub workflow. Based on the metrics received, make decisions on whether or not to release in the production environment.</p>
<h2 id="exercise-1-code-changes-to-fetch-availability-and-latency-from-application-insights-and-app-service-http-logs-from-log-analytics">Exercise 1: Code changes to fetch availability and latency from Application Insights, and App Service HTTP logs from Log Analytics</h2>
<hr>
<p>In this exercise, we will enable the steps to get AppInsights API Id &amp; API Key for PRD environment only, which is used in the last stage of Release_to_Next_Env to query <strong>AppInsights availability and latency</strong> of PRD environment and ensuring the environment is running as expected before releasing the updates.</p>
<h3 id="prerequisites---exercise-1">Prerequisites - Exercise 1</h3>
<hr>
<ul>
<li>Continuous Security Labs must be completed.</li>
</ul>
<hr>
<ol>
<li><p>Open the GitHub Codespaces if you have one already created. If not, go ahead and select <code>+ New codespace</code>.</p>
<p><img src="../../media/github-codespaces.gif" alt="Open GitHub codespaces"></p>
</li>
<li><p>Create a new branch following the <code>users/{user_alias}/{purpose_of_the_branch}</code> schema.</p>
</li>
<li><p>Open the <code>/.github/workflows/environment-template.yml</code> file. Search for <code>SLO_Check</code> job. Uncomment that block to enable the SLO checks. You can use shortcut <code>Ctrl + k + u</code> to uncomment and <code>Ctrl + k + c</code> to comment out a block of code.</p>
</li>
<li><p>Now open the <code>.github/actions/continuous-operation/action.yml</code> file. Below 4 actions in the yaml file will enable evaluation of latency and availability from Application Insights of PRD application.</p>
<ul>
<li><strong>Get Latency</strong>: This action is used to get the latency of the PRD application using App Insights API</li>
<li><strong>Check Latency</strong>: This action is used to evaluate the latency of the PRD application. If it is less than the threshold, which is set in the all-stages variable group, the pipeline proceeds to PRD or else it stops release to PRD.</li>
<li><strong>Get Availability</strong>: This action is used to get the availability of the PRD coupons application using App Insights API</li>
<li><strong>Check Availability</strong>: This action is used to evaluate the availability of the PRD coupons application. If it is equal to 1 i.e. it is available, the pipeline proceeds to PRD or else if it is equal to 0 it stops release to PRD.</li>
</ul>
</li>
<li><p>Now go to the continuous-delivery composite action and take a look to the <code>Generate AppInsights API Key</code> step. when the Continuous delivery workflow runs in QA environment, it will generate an AppInsights API key and store it as a secret in a keyvault. This key will then be utilized to fetch <code>Latency</code> and <code>Availability</code> from AppInsights for the PRD application. We do this in QA because it is a mirror environment of PRD.</p>
</li>
<li><p>Commit the code changes and push your branch to remote as described below:</p>
<p><img src="../../media/commit-changes.gif" alt="Commit Changes"></p>
</li>
<li><p>Go to the GitHub code changes in browser and raise a pull request. Link both, the commit and pull request, to the specific task in ADO by using the <code>AB#{work_item_id}</code> format. Put some meaningful description and put some reviewers from your team as shown below:</p>
<p><img src="../../media/create-pull-request.png" alt="Raise pull request"></p>
</li>
<li><p>As part of the pull request check, the CI and CodeQl workflows will be triggered. Once the pull requests is approved and checks have been passed, you can merge the changes into the <code>main</code> branch.</p>
<p><img src="../../media/pr-checks.png" alt="Kickoff required workflows"></p>
</li>
<li><p>Once the pull request is approved and checks have been passed, you can merge the changes into the <code>main</code> branch. As part of this merge, the CI workflow will be triggered again. If successfully executed, then the CD workflow will be triggered afterwards. Monitor the progress of the workflow from <code>Actions</code> tab.</p>
</li>
</ol>
<h1 id="key-takeaways"><strong>Key takeaways</strong></h1>
<hr>
<ul>
<li>Application Insights and Log Analytics can be utilized to get key SLO metrics. THey can be integrated into workflows to make decisions of release to production environment.</li>
</ul>
<hr>
<h2 id="whats-next-">What's Next ?</h2>
<hr>
<p><a href="module2.html">Module 2 - Simulate SLO metrics pass/fail scenario</a></p>
</article>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
              <!-- <p><a class="back-to-top" href="#top">Back to top</a><p> -->
              </nav>
            </div>
          </div>
        </div>
      </div>
      <footer class="w-100 py-2">
          <div class="container my-2">
              <div class="hacker white"></div>
              <div class="hacker orange"></div>
              <div class="hacker green"></div>
              <div class="hacker black"></div>
              <div class="dojo-teams hidden-xs hidden-sm"></div>
          </div>
      </footer>    </div>

    <script type="text/javascript" src="../../../../../../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../../../../../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../../../../../styles/main.js"></script>
  </body>
</html>
